#!/usr/bin/env bash

# bin/compile <build-dir> <cache-dir> <env-dir>


# fail hard
set -o pipefail
# fail harder
set -eu
# move hidden files too, just in case
shopt -s dotglob

#STACK=${STACK:-cedar-14} # Anvil has none
build_dir=$1
orig_cache_dir=$2
cache_dir=$2/php
mkdir -p "$cache_dir"
env_dir=${3:-} # Anvil has none

git clone --quiet https://github.com/heroku/heroku-buildpack-php /app/heroku-buildpack-php

# Use library from heroku-buildpack-php.
source /app/heroku-buildpack-php/bin/util/common.sh

## Install sqlite
#source ./bin/util/install-sqlite.sh
#install_sqlite

# Install minimal composer
source ./bin/util/install-composer.sh
install_minimal_composer

#export PHP_OPTIONS='-d sqlite3.extension_dir="/app/.sqlite"'

# Set up Composer
export COMPOSER_HOME=$cache_dir/.composer
mkdir -p $COMPOSER_HOME

composer() {
	/app/.php/php-min/bin/php /app/.php/php/bin/composer "$@"
}

echo "-----> Build composer.lock"

### Build thunder project.
mv $build_dir /app/thunder
mkdir $build_dir

TEST_DIR=$build_dir
THUNDER_DIST_DIR=$build_dir/thunder-distribution
export COMPOSER_MEMORY_LIMIT=-1

composer create-project thunder/thunder-project:3.x ${TEST_DIR} --stability dev --no-interaction --no-install

cd ${TEST_DIR}

mv /app/thunder ${THUNDER_DIST_DIR}

composer config repositories.thunder path ${THUNDER_DIST_DIR}
composer config name "this/thunder-distribution" --working-dir="${THUNDER_DIST_DIR}"
composer remove thunder/thunder-distribution --no-update

composer require "this/thunder-distribution:*" "thunder/thunder_testing_demo:3.x-dev" "composer/composer:^1.9.0" --no-update

# Add platform requirements.
composer require "php:>=7.4" "ext-pdo_sqlite:*" --no-update --ignore-platform-reqs

composer install --no-dev --no-progress --ignore-platform-reqs

# Add runtime command.
echo "web: heroku-php-apache2 docroot" > Procfile

# Add install after php is setup correctly.
composer config scripts.compile.0  "php ./docroot/core/scripts/drupal install thunder"

# Let php build pack do its thing
/app/heroku-buildpack-php/bin/compile ${TEST_DIR} $orig_cache_dir $env_dir
